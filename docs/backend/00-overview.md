# Paimon Prime Fund 后端系统设计文档

> 版本: 1.0.0
> 日期: 2024-12-13
> 状态: 规划中

---

## 1. 文档索引

| 文档 | 描述 |
|------|------|
| [00-overview.md](./00-overview.md) | 系统概述与架构（本文档） |
| [01-event-listener.md](./01-event-listener.md) | 事件监听模块设计 |
| [02-rebalance-engine.md](./02-rebalance-engine.md) | 调仓引擎设计 |
| [03-risk-control.md](./03-risk-control.md) | 风控系统设计 |
| [04-approval-workflow.md](./04-approval-workflow.md) | 审批工作流设计 |
| [05-api-specification.md](./05-api-specification.md) | API 规范 |
| [06-database-design.md](./06-database-design.md) | 数据库设计 |
| [07-permission-management.md](./07-permission-management.md) | 权限管理设计 |
| [08-deployment.md](./08-deployment.md) | 部署与运维 |

---

## 2. 项目背景

### 2.1 业务概述

Paimon Prime Fund 是一个部署在 BSC 链上的 **主动管理型 RWA 指数基金**，核心特点：

- **基金份额代币化**：用户通过 USDT 按当前净值(NAV)购买基金份额(PPT Token)
- **三层流动性管理**：L1(现金) + L2(货币基金) + L3(高收益RWA资产)
- **多通道赎回机制**：标准(T+7) / 紧急(T+1) / 定期(季度窗口)
- **分级审批流程**：基于金额和流动性比例的多级审批

### 2.2 合约架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Smart Contract Layer                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────────┐  ┌──────────────────┐   │
│  │  PNGYVault   │  │ RedemptionManager│  │ AssetController  │   │
│  │  (ERC4626)   │  │   (赎回管理)      │  │   (资产管理)     │   │
│  └──────┬───────┘  └────────┬─────────┘  └────────┬─────────┘   │
│         │                   │                     │              │
│         └───────────────────┼─────────────────────┘              │
│                             │                                    │
│  ┌──────────────────────────┴────────────────────────────────┐  │
│  │                    External Adapters                       │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐             │  │
│  │  │  Oracle    │ │   Swap     │ │    OTC     │             │  │
│  │  │  Adapter   │ │  Helper    │ │  Manager   │             │  │
│  │  └────────────┘ └────────────┘ └────────────┘             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 核心业务流程

#### 申购流程
```
用户 USDT → PNGYVault.deposit() → 铸造 PPT 份额 → 资金进入 L1
```

#### 赎回流程
```
用户发起赎回 → 判断通道 → 锁定份额 → [等待/审批] → 结算 → 返还 USDT
```

#### 调仓流程
```
监控偏离度 → 计算调仓计划 → [审批] → 执行交易 → 更新状态
```

---

## 3. 后端系统定位

### 3.1 核心职责

后端系统承担以下五大职责：

| 职责 | 描述 | 重要性 |
|------|------|--------|
| **链上监控** | 实时监听合约事件，同步链上状态 | 🔴 Critical |
| **调仓执行** | 根据策略自动/手动执行资产调仓 | 🔴 Critical |
| **风控预警** | 监控风险指标，触发告警和响应 | 🔴 Critical |
| **审批工作流** | 处理需要人工审批的操作请求 | 🟡 High |
| **数据聚合** | 聚合链上数据，提供查询和报表 | 🟢 Normal |

### 3.2 系统边界

```
┌─────────────────────────────────────────────────────────────────┐
│                         系统边界                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  后端系统负责:                         后端系统不负责:           │
│  ✅ 监听链上事件                       ❌ 用户钱包管理            │
│  ✅ 执行调仓交易                       ❌ 用户申购/赎回入口       │
│  ✅ 风险监控告警                       ❌ 合约升级部署            │
│  ✅ 审批流程管理                       ❌ 私钥托管                │
│  ✅ 数据统计报表                       ❌ 合规审计报告            │
│  ✅ 管理员仪表板                       ❌ 用户前端界面            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 系统架构

### 4.1 总体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Paimon Backend System                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        Gateway Layer                             │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│  │  │   REST API  │  │  WebSocket  │  │   Admin UI  │              │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                    │                                     │
│  ┌─────────────────────────────────┴───────────────────────────────┐    │
│  │                       Application Layer                          │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │    │
│  │  │  Event    │ │ Rebalance │ │   Risk    │ │  Approval │       │    │
│  │  │ Listener  │ │  Engine   │ │  Control  │ │ Workflow  │       │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │    │
│  │  │  Report   │ │Notification│ │ Scheduler │ │  Oracle   │       │    │
│  │  │  Service  │ │  Service  │ │  Service  │ │  Service  │       │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                    │                                     │
│  ┌─────────────────────────────────┴───────────────────────────────┐    │
│  │                        Domain Layer                              │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │    │
│  │  │   Vault   │ │Redemption │ │   Asset   │ │   User    │       │    │
│  │  │  Domain   │ │  Domain   │ │  Domain   │ │  Domain   │       │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                    │                                     │
│  ┌─────────────────────────────────┴───────────────────────────────┐    │
│  │                     Infrastructure Layer                         │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │    │
│  │  │PostgreSQL │ │   Redis   │ │TimescaleDB│ │  Message  │       │    │
│  │  │ (主数据)  │ │  (缓存)   │ │(时序数据) │ │   Queue   │       │    │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                     │    │
│  │  │Blockchain │ │    KMS    │ │  Logger   │                     │    │
│  │  │  Client   │ │ (密钥管理)│ │  (日志)   │                     │    │
│  │  └───────────┘ └───────────┘ └───────────┘                     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 模块交互关系

```
┌──────────────────────────────────────────────────────────────────────┐
│                          模块交互关系图                               │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│                         ┌─────────────┐                              │
│                         │  Blockchain │                              │
│                         │   (BSC)     │                              │
│                         └──────┬──────┘                              │
│                                │                                      │
│                                ▼                                      │
│                    ┌───────────────────────┐                         │
│                    │    Event Listener     │                         │
│                    │  (实时监听链上事件)    │                         │
│                    └───────────┬───────────┘                         │
│                                │                                      │
│           ┌────────────────────┼────────────────────┐                │
│           │                    │                    │                │
│           ▼                    ▼                    ▼                │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐        │
│  │ Risk Control    │ │ Approval        │ │ Report          │        │
│  │ (风险监控)      │ │ Workflow        │ │ Service         │        │
│  │                 │ │ (审批工作流)    │ │ (数据聚合)      │        │
│  └────────┬────────┘ └────────┬────────┘ └─────────────────┘        │
│           │                   │                                      │
│           │    ┌──────────────┘                                      │
│           │    │                                                     │
│           ▼    ▼                                                     │
│  ┌─────────────────┐          ┌─────────────────┐                   │
│  │ Rebalance       │◄────────►│ Notification    │                   │
│  │ Engine          │          │ Service         │                   │
│  │ (调仓引擎)      │          │ (通知服务)      │                   │
│  └────────┬────────┘          └─────────────────┘                   │
│           │                                                          │
│           ▼                                                          │
│  ┌─────────────────┐                                                │
│  │  Blockchain     │                                                │
│  │  (执行交易)     │                                                │
│  └─────────────────┘                                                │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 5. 技术选型

### 5.1 技术栈

| 层次 | 技术选型 | 版本 | 选型理由 |
|------|----------|------|----------|
| **语言** | Python | 3.11+ | 成熟稳定、生态丰富、Web3支持好 |
| **Web框架** | FastAPI | 0.100+ | 高性能异步、自动文档、类型提示 |
| **ORM** | SQLAlchemy | 2.x | 功能强大、灵活、异步支持 |
| **数据库迁移** | Alembic | 1.x | SQLAlchemy原生集成 |
| **链交互** | web3.py | 6.x | Python生态标准、功能完整 |
| **主数据库** | PostgreSQL | 16 | 可靠、功能丰富 |
| **时序数据** | TimescaleDB | 2.x | PostgreSQL扩展、时序优化 |
| **缓存** | Redis | 7.x | 高性能、丰富数据结构 |
| **异步任务** | Celery | 5.x | 分布式任务队列、成熟稳定 |
| **任务调度** | APScheduler | 3.x | 灵活的调度器 |
| **日志** | structlog | 23.x | 结构化日志、高性能 |
| **监控** | Prometheus | - | 行业标准 |
| **可视化** | Grafana | - | 强大仪表板 |
| **API文档** | Swagger/OpenAPI | 3.x | FastAPI自动生成 |

### 5.2 外部依赖

| 服务 | 用途 | 备选方案 |
|------|------|----------|
| **BSC RPC** | 链上交互 | QuickNode / Alchemy / 自建节点 |
| **AWS KMS** | 密钥管理 | HashiCorp Vault / GCP KMS |
| **Slack** | 告警通知 | Telegram / Discord / PagerDuty |
| **S3** | 报表存储 | MinIO / GCS |

---

## 6. 关键设计决策

### 6.1 事件驱动架构

**决策**: 采用事件驱动架构，所有业务逻辑由链上事件触发

**理由**:
- 链上状态是唯一真相来源
- 自然实现幂等性和最终一致性
- 便于扩展和解耦

### 6.2 链上状态同步策略

**决策**: 定期快照 + 事件增量更新

**理由**:
- 快照提供一致性基准
- 事件提供实时性
- 两者结合保证数据准确

### 6.3 调仓执行策略

**决策**: 模拟优先、审批分级、失败重试

**理由**:
- eth_call 模拟避免链上失败
- 分级审批平衡效率和安全
- 重试机制提高可靠性

### 6.4 多签钱包使用

**决策**:
- 日常操作: 热钱包 (单签)
- 大额操作: 温钱包 (多签 2/3)
- 紧急操作: 冷钱包 (多签 3/5)

**理由**:
- 平衡效率和安全
- 分级管控风险

---

## 7. 非功能性需求

### 7.1 性能要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API 响应时间 | P99 < 500ms | 常规查询 |
| 事件处理延迟 | < 30s | 从出块到入库 |
| 系统可用性 | 99.9% | 月度 SLA |
| 数据一致性 | 最终一致 | < 1分钟延迟 |

### 7.2 安全要求

| 领域 | 要求 |
|------|------|
| 认证 | JWT + 钱包签名双重认证 |
| 授权 | RBAC 细粒度权限控制 |
| 传输 | 全链路 HTTPS/TLS |
| 存储 | 敏感数据加密存储 |
| 审计 | 所有操作完整审计日志 |
| 密钥 | HSM/KMS 托管、定期轮换 |

### 7.3 可观测性要求

| 维度 | 实现 |
|------|------|
| 日志 | 结构化 JSON 日志 + ELK |
| 指标 | Prometheus + Grafana |
| 追踪 | OpenTelemetry |
| 告警 | PagerDuty / Slack |

---

## 8. 开发路线图

### Phase 1: 基础设施 (Week 1-2)

- [ ] 项目初始化 (FastAPI 项目结构)
- [ ] CI/CD 流水线配置
- [ ] 数据库 Schema 设计 (SQLAlchemy + Alembic)
- [ ] 链交互层封装 (web3.py)
- [ ] 认证授权模块

### Phase 2: 核心功能 (Week 3-5)

- [ ] 事件监听服务
- [ ] 数据同步服务
- [ ] 赎回管理模块
- [ ] 审批工作流模块

### Phase 3: 调仓与风控 (Week 6-8)

- [ ] 调仓策略引擎
- [ ] 调仓执行服务
- [ ] 风控监控模块
- [ ] 流动性预测模型

### Phase 4: 仪表板与报表 (Week 9-10)

- [ ] 管理仪表板 API
- [ ] 报表生成服务
- [ ] WebSocket 实时推送

### Phase 5: 安全加固与上线 (Week 11-12)

- [ ] 安全审计
- [ ] 渗透测试
- [ ] 压力测试
- [ ] 灰度发布

---

## 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|------|------|
| **AUM** | Assets Under Management，管理资产总额 |
| **NAV** | Net Asset Value，每份额净值 |
| **PPT** | Paimon Prime Token，基金份额代币 |
| **L1/L2/L3** | 三层流动性层级 |
| **RWA** | Real World Assets，现实世界资产 |
| **瀑布清算** | 按优先级从高层向低层清算资产 |

### 9.2 参考文档

- [ERC-4626 标准](https://eips.ethereum.org/EIPS/eip-4626)
- [OpenZeppelin AccessControl](https://docs.openzeppelin.com/contracts/4.x/access-control)
- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [SQLAlchemy 文档](https://docs.sqlalchemy.org/)
- [web3.py 文档](https://web3py.readthedocs.io/)
- [Celery 文档](https://docs.celeryq.dev/)

---

*文档持续更新中，详细设计请参阅各子模块文档。*
