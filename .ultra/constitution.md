# Project Constitution - Paimon Prime Fund Backend

This document defines the core principles and standards for the Paimon Prime Fund backend system. It serves as the foundation for all development decisions.

> **Configuration Values**: All numeric thresholds and limits are defined in `.ultra/config.json`. This document provides the **qualitative principles** only.
>
> **Detailed Specifications**: See `docs/backend/` for comprehensive module designs.

## Development Principles

### 1. Specification-Driven
- Specifications are the source of truth
- Code derives from specs in `docs/backend/`
- Changes require spec updates first

### 2. Test-First Development
- Write tests before implementation
- Coverage targets: 80% overall, 100% critical paths
- Integration tests with real services (PostgreSQL, Redis)

### 3. Event-Driven Architecture
- Chain events are the single source of truth
- All business logic triggered by on-chain events
- Natural idempotency and eventual consistency

### 4. Chain State Synchronization
- Periodic snapshots + event-based incremental updates
- Snapshots provide consistency baseline
- Events provide real-time updates

### 5. Library-First
- Extract reusable logic to libraries
- Internal packages for shared code
- web3.py for all blockchain interactions

### 6. Simplicity
- Maximum 3 layers of abstraction
- Function size limits defined in config.json
- Favor readability over cleverness

### 7. Single Source of Truth
- Chain state is authoritative
- Specs in `.ultra/specs/`
- Decisions in ADRs

### 8. Explicit Decisions
- All architecture decisions documented
- Rationale traces to requirements
- Trade-offs acknowledged

### 9. Living Documentation
- Documentation evolves with code
- Specs updated with every feature
- docs/backend/ is comprehensive

## Quality Standards

### Code Quality
- SOLID principles enforced
- DRY: No duplication > 3 lines
- KISS: Low complexity < 10
- YAGNI: Only current requirements
- Python type hints mandatory
- Async/await for I/O operations

### Testing
- Test coverage: 80% overall, 100% critical paths
- Six-dimensional coverage:
  1. Functional (core logic)
  2. Boundary (edge cases)
  3. Exception (error handling)
  4. Performance (load tests)
  5. Security (injection prevention)
  6. Compatibility (API versioning)

### Performance Targets
- API P99 < 500ms
- Event processing delay < 30s
- System availability > 99.9%
- Data consistency < 1 minute delay

## Technology Constraints

### Mandatory Stack
- **Language**: Python 3.11+
- **Web Framework**: FastAPI 0.100+
- **ORM**: SQLAlchemy 2.x (async)
- **Database Migration**: Alembic 1.x
- **Blockchain**: web3.py 6.x
- **Main Database**: PostgreSQL 16
- **Time-Series**: TimescaleDB 2.x
- **Cache**: Redis 7.x
- **Task Queue**: Celery 5.x
- **Scheduler**: APScheduler 3.x
- **Logging**: structlog 23.x
- **Monitoring**: Prometheus + Grafana

### Security Requirements
- JWT + Wallet Signature dual authentication
- RBAC fine-grained permission control
- Full HTTPS/TLS transport
- Sensitive data encrypted at rest
- Complete audit logging
- HSM/KMS key management

### API Standards
- RESTful API design
- OpenAPI 3.x documentation (auto-generated by FastAPI)
- Conventional response format (success/error)
- Pagination for list endpoints
- Rate limiting

## Git Workflow

- Branch naming: `feat/task-{id}-{description}`, `fix/bug-{id}-{description}`
- Commit format: Conventional Commits
- Independent branches: Each task gets its own branch
- Immediate merge: Merge to main after task completion

## Architecture Decision Process

All significant technical decisions must:
1. Be documented as ADRs in `.ultra/docs/decisions/`
2. Include context, decision, rationale, consequences
3. Be reviewed and approved
4. Link back to requirements in specs

## Module Responsibilities

| Module | Responsibility | Priority |
|--------|----------------|----------|
| Event Listener | Real-time chain event monitoring | Critical |
| Rebalance Engine | Asset rebalancing execution | Critical |
| Risk Control | Risk monitoring and alerts | Critical |
| Approval Workflow | Multi-level approval process | High |
| Report Service | Data aggregation and reporting | Normal |

## Customization Notes

This constitution is tailored for the Paimon Prime Fund backend system:
- Blockchain integration is core requirement
- Event-driven architecture is mandatory
- Multi-signature wallet support required
- Three-tier liquidity management (L1/L2/L3)

---

Last Updated: 2024-12-13
